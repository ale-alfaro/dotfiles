<html class="_theme-default">
<head>
    <meta charset="utf-8">
    <title>script.type.speculationrules</title>
    
    <link rel="preload" href="../../../../assets/index.js" as="script" type="text/javascript" />

    <link rel="stylesheet" type="text/css" href="../../../../application.css" />
    <link rel="stylesheet" type="text/css" href="../../../../assets/index.css" />
</head>
<body>
    <div class="_app">
        <devdocs-navbar current="reference/elements/script/type/speculationrules" prefix="../../../../" listing-src="../../../../navbar.json"></devdocs-navbar>
        <div class="_container">
            <main class="_content">
                <div class="_page _html"><header><h1>&lt;script type="speculationrules"&gt;</h1>
<details class="baseline-indicator not"><summary><div class="status-title"><span class="not-bold">Limited availability</span></div>

</summary><div class="extra">
<p>This feature is not Baseline because it does not work in some of the most widely-used browsers.</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Baseline/Compatibility" data-glean="baseline_link_learn_more" target="_blank" class="learn-more">Learn more</a></li>
<li><a href="#browser_compatibility" data-glean="baseline_link_bcd_table">See full compatibility</a></li>
<li><a href="https://survey.alchemer.com/s3/7634825/MDN-baseline-feedback?page=%2Fen-US%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fscript%2Ftype%2Fspeculationrules&amp;level=not" data-glean="baseline_link_feedback" class="feedback-link" target="_blank" rel="noreferrer">Report feedback</a></li>
</ul>
</div></details></header><div class="section-content">
<div class="notecard experimental"><p><strong>Experimental:</strong> <strong>This is an <a href="https://developer.mozilla.org/en-US/docs/MDN/Writing_guidelines/Experimental_deprecated_obsolete#experimental">experimental technology</a></strong><br>Check the <a href="#browser_compatibility">Browser compatibility table</a> carefully before using this in production.</p></div> <p>The <code>speculationrules</code> value of the <a href="../type"><code>type</code></a> attribute of the <a href="../../script"><code>&lt;script&gt;</code> element</a> indicates that the body of the element contains speculation rules.</p> <p>Speculation rules take the form of a JSON structure that determine what resources should be prefetched or prerendered by the browser. This is part of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Speculation_Rules_API">Speculation Rules API</a>.</p> <div class="notecard note"> <p><strong>Note:</strong> Speculation rules can be defined inside external text files referenced by the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Speculation-Rules"><code>Speculation-Rules</code></a> HTTP header, using the same <a href="#speculation_rules_json_representation">JSON representation provided below</a>. Specifying an HTTP header is useful in cases where developers are not able to directly modify the document itself.</p> </div>
</div>
<h2 id="syntax">Syntax</h2>
<div class="section-content">
<div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  // JSON object defining rules
&lt;/script&gt;
</pre></div> <div class="notecard note"> <p><strong>Note:</strong> The <code>src</code>, <code>async</code>, <code>nomodule</code>, <code>defer</code>, <code>crossorigin</code>, <code>integrity</code>, and <code>referrerpolicy</code> attributes must not be specified.</p> </div>
</div>
<h3 id="exceptions">Exceptions</h3>
<div class="section-content"><dl> <dt id="typeerror"><a href="#typeerror"><code>TypeError</code></a></dt> <dd> <p>The speculation rules definition is not a valid JSON object.</p> </dd> </dl></div>
<h2 id="description">Description</h2>
<div class="section-content">
<p>A <code>&lt;script type="speculationrules"&gt;</code> element must contain a valid JSON structure that defines speculation rules. The following examples show separate prefetch and prerender rules:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        "urls": ["next.html", "next2.html"],
        "requires": ["anonymous-client-ip-when-cross-origin"],
        "referrer_policy": "no-referrer"
      }
    ]
  }
&lt;/script&gt;
</pre></div> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prerender": [
      {
        "where": { "href_matches": "/next" },
        "eagerness": "eager"
      }
    ]
  }
&lt;/script&gt;
</pre></div>
</div>
<h3 id="speculation_rules_json_representation">Speculation rules JSON representation</h3>
<div class="section-content">
<p>The JSON structure contains one or more fields at the top level, each one representing an action to define speculation rules for. At present the supported actions are:</p> <dl> <dt id="prefetch"><a href="#prefetch"><code>"prefetch"</code> <span class="badge inline optional">Optional</span> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>Rules for potential future navigations that should have their associated document response body downloaded, leading to significant performance improvements when those documents are navigated to. Note that none of the subresources referenced by the page are downloaded.</p> </dd> <dt id="prerender"><a href="#prerender"><code>"prerender"</code> <span class="badge inline optional">Optional</span> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>Rules for potential future navigations that should have their associated documents fully downloaded, rendered, and loaded into an invisible tab. This includes loading all subresources, running all JavaScript, and even loading subresources and performing data fetches started by JavaScript. When those documents are navigated to, navigations will be instant, leading to major performance improvements.</p> </dd> </dl> <div class="notecard note"> <p><strong>Note:</strong> Consult the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Speculation_Rules_API">Speculation Rules API</a> main page for full details on how to use prefetch and prerender effectively.</p> </div> <p>Each action field contains an array, which in turn contains one or more objects. Each object contains a single rule defining a set of URLs and related parameters.</p> <p>Each object can contain the following properties:</p> <dl> <dt id="source"><a href="#source"><code>"source"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>A string indicating the source of the URLs to which the rule applies. This is optional because the value can always be inferred from other properties.</p> <p>This can be one of:</p> <dl> <dt id="document"><a href="#document"><code>"document"</code></a></dt> <dd> <p>Specifies that the URLs will be matched from navigation links in the associated document (as defined in <a href="../../a"><code>&lt;a&gt;</code></a> and <a href="../../area"><code>&lt;area&gt;</code></a> elements), based on the conditions described by a <code>"where"</code> key. Note that the presence of a <code>"where"</code> key implies <code>"source": "document"</code>, so it is optional.</p> </dd> <dt id="list"><a href="#list"><code>"list"</code></a></dt> <dd> <p>Specifies that the URLs will come from a list, specified in the <code>"urls"</code> key. Note that the presence of a <code>"urls"</code> key implies <code>"source": "list"</code>, so it is optional.</p> </dd> </dl> </dd> <dt id="urls"><a href="#urls"><code>"urls"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>An array of strings representing a list of URLs to apply the rule to. These can be absolute or relative URLs. Relative URLs will be parsed relative to the document base URL (if inline in a document) or relative to the external resource URL (if externally fetched). <code>"urls"</code> and <code>"where"</code> cannot both be set in the same rule.</p> </dd> <dt id="where"><a href="#where"><code>"where"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>An object representing the conditions by which the rule matches URLs contained in the associated document. Effectively, the <code>"where"</code> object represents a test that is performed on every link on the page to see whether the speculation rule is applied to it. <code>"where"</code> and <code>"urls"</code> cannot both be set in the same rule.</p> <p>This object can contain exactly one of the following properties:</p> <dl> <dt id="href_matches"><a href="#href_matches"><code>"href_matches"</code></a></dt> <dd> <p>A string containing a URL pattern, or an array containing multiple URL pattern strings, which follow the standard <a href="https://developer.mozilla.org/en-US/docs/Web/API/URL_Pattern_API">URL Pattern API syntax</a>. Links in the document whose URLs match the pattern(s) will have the rule applied.</p> </dd> <dt id="relative_to"><a href="#relative_to"><code>"relative_to"</code></a></dt> <dd> <p>In the case of an <code>"href_matches"</code> condition, this can specify where you want that condition to be matched relative to. This works in exactly the same way as the <a href="#relative_to_2">rule-level <code>"relative_to"</code> key</a>, except that it only affects a single <code>"href_matches"</code> condition inside a <code>"where"</code> key.</p> </dd> <dt id="selector_matches"><a href="#selector_matches"><code>"selector_matches"</code></a></dt> <dd> <p>A string containing a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_selectors">CSS selector</a>, or an array containing multiple CSS selectors. Links in the document matched by those selectors will have the rule applied.</p> </dd> <dt id="and"><a href="#and"><code>"and"</code></a></dt> <dd> <p>An array containing one or more objects containing conditions (<code>"href_matches"</code>, <code>"selector_matches"</code>, <code>"and"</code>, <code>"not"</code>, or <code>"or"</code>), all of which must match for the rule to be applied to them.</p> </dd> <dt id="not"><a href="#not"><code>"not"</code></a></dt> <dd> <p>An object containing one condition (<code>"href_matches"</code>, <code>"selector_matches"</code>, <code>"and"</code>, <code>"not"</code>, or <code>"or"</code>) which, if it matches, will <em>not</em> have the rule applied to it. All links that <em>do not</em> match the condition <em>will</em> have the rule applied.</p> </dd> <dt id="or"><a href="#or"><code>"or"</code></a></dt> <dd> <p>An array containing one or more objects containing conditions (<code>"href_matches"</code>, <code>"selector_matches"</code>, <code>"and"</code>, <code>"not"</code>, or <code>"or"</code>), any of which can match for the rule to be applied to them.</p> </dd> </dl> <p><code>"where"</code> conditions can be nested multiple levels deep to create complex conditions, or you can choose to split them into separate rules to keep them simple. See <a href="#where_syntax_examples">where examples</a> for more explanation, and multiple examples of use.</p> </dd> <dt id="eagerness"><a href="#eagerness"><code>"eagerness"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>A string providing a hint to the browser as to how eagerly it should prefetch/prerender link targets in order to balance performance advantages against resource overheads. Possible values are:</p> <dl> <dt id="immediate"><a href="#immediate"><code>"immediate"</code></a></dt> <dd> <p>The author thinks the link is very likely to be followed, and/or the document may take significant time to fetch. Prefetch/prerender should start as soon as possible, subject only to considerations such as user preferences and resource limits.</p> </dd> <dt id="eager"><a href="#eager"><code>"eager"</code></a></dt> <dd> <p>The author wants to prefetch/prerender a large number of navigations, as early as possible. Prefetch/prerender should start on any slight suggestion that a link may be followed. For example, the user could move their mouse cursor towards the link, hover/focus it for a moment, or pause scrolling with the link in a prominent place.</p> </dd> <dt id="moderate"><a href="#moderate"><code>"moderate"</code></a></dt> <dd> <p>The author is looking for a balance between <code>eager</code> and <code>conservative</code>. Prefetch/prerender should start when there is a reasonable suggestion that the user will follow a link in the near future. For example, the user could scroll a link into the viewport and hover/focus it for some time.</p> </dd> <dt id="conservative"><a href="#conservative"><code>"conservative"</code></a></dt> <dd> <p>The author wishes to get some benefit from speculative loading with a fairly small tradeoff of resources. Prefetch/prerender should start only when the user is starting to click on the link, for example on <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/mousedown_event"><code>mousedown</code></a> or <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/pointerdown_event"><code>pointerdown</code></a>.</p> </dd> </dl> <p>If <code>"eagerness"</code> is not explicitly specified, list (<code>"urls"</code>) rules default to <code>immediate</code> and document (<code>"where"</code>) rules default to <code>conservative</code>. The browser takes this hint into consideration along with its own heuristics, so it may select a link that the author has hinted as less eager than another, if the less eager candidate is considered a better choice.</p> </dd> <dt id="expects_no_vary_search"><a href="#expects_no_vary_search"><code>"expects_no_vary_search"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>A string providing a hint to the browser as to what <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/No-Vary-Search"><code>No-Vary-Search</code></a> header value will be set on responses for documents that it is receiving prefetch/prerender requests for. The browser can use this to determine ahead of time whether it is more useful to wait for an existing prefetch/prerender to finish, or start a new fetch request when the speculation rule is matched. See the <a href="#expects_no_vary_search_example"><code>"expects_no_vary_search"</code> example</a> for more explanation of how this can be used.</p> </dd> <dt id="referrer_policy"><a href="#referrer_policy"><code>"referrer_policy"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>A string representing a specific referrer policy string to use when requesting the URLs specified in the rule — see <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Referrer-Policy"><code>Referrer-Policy</code></a> for possible values. The purpose of this is to allow the referring page to set a stricter policy specifically for the speculative request than the policy the page already has set (either by default, or by using <code>Referrer-Policy</code>).</p> <div class="notecard note"> <p><strong>Note:</strong> A cross-site prefetch requires a referrer policy that is at least as strict as the default <code>"strict-origin-when-cross-origin"</code> value — so <code>"strict-origin-when-cross-origin"</code>, <code>"same-origin"</code>, <code>"strict-origin"</code>, or <code>"no-referrer"</code>. A laxer policy set in the speculation rules will override a stricter policy set on the referring page as long as it is still sufficiently strict for the cross-site case.</p> </div> <div class="notecard note"> <p><strong>Note:</strong> In the case of document rules, the matched link's specified referrer policy (e.g., using the <a href="../../a#referrerpolicy"><code>referrerpolicy</code></a> attribute) will be used, unless the rule specifies a policy that overrides it.</p> </div> </dd> <dt id="relative_to_2"><a href="#relative_to_2"><code>"relative_to"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>A string specifying where you want links matched by URL to be matched relative to. The value can be one of:</p> <dl> <dt id="document_2"><a href="#document_2"><code>document</code></a></dt> <dd> <p>URLs should be matched relative to the document the speculation rules are being set on.</p> </dd> <dt id="ruleset"><a href="#ruleset"><code>ruleset</code></a></dt> <dd> <p>URLs should be matched relative to the file the rules are specified in. This is the default value.</p> </dd> </dl> <p>This key setting is only relevant for rules defined in an external file (set using the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Speculation-Rules"><code>Speculation-Rules</code></a> header). When rules are specified inside the same document they are being set for (i.e., in an inline <code>&lt;script&gt;</code> element), it makes no difference.</p> </dd> <dt id="requires"><a href="#requires"><code>"requires"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>An array of strings representing capabilities of the browser parsing the rule, which must be available if the rule is to be applied to the specified URLs.</p> <div class="notecard warning"> <p><strong>Warning:</strong> Prefetches will automatically fail in browsers that cannot meet a specified requirement, even if they support the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Speculation_Rules_API">Speculation Rules API</a>.</p> </div> <p>Possible values are:</p> <dl> <dt id="anonymous-client-ip-when-cross-origin"><a href="#anonymous-client-ip-when-cross-origin"><code>"anonymous-client-ip-when-cross-origin"</code></a></dt> <dd> <p>(prefetch-only) Specifies that the rule matches only if the user agent can prevent the client IP address from being visible to the origin server if a cross-origin prefetch request is issued. Exactly how this works is dependent on browser implementation specifics. For example:</p> <ul> <li>Chrome's implementation hides the IP address using a Google-owned proxy, therefore by default it only works for Google-controlled referrers (since in that case, sending the URLs of the destination to Google is not an additional privacy leak). When used on a non-Google-owned site, rules that include this will only match for users that turn on "Enhanced preloading" in <code>chrome://settings/preloading</code>.</li> <li>Other Chromium-based browsers will have to provide their own solutions. Thorough testing in all target browsers is advised.</li> <li>A future Safari implementation may possibly use something along the lines of <a href="https://support.apple.com/en-us/102602" target="_blank">iCloud Private Relay</a>.</li> <li>A future Firefox implementation might use something based on the <a href="https://www.mozilla.org/en-US/products/vpn/" target="_blank">Mozilla VPN</a> product.</li> </ul> </dd> </dl> </dd> <dt id="tag"><a href="#tag"><code>"tag"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>A string used to identify a rule or ruleset. This will be included in the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Sec-Speculation-Tags"><code>Sec-Speculation-Tags</code></a> request header for any speculations covered by that rule.</p> </dd> <dt id="target_hint"><a href="#target_hint"><code>"target_hint"</code> <abbr class="icon icon-experimental" title="Experimental. Expect behavior to change in the future."> <span class="visually-hidden">Experimental</span> </abbr></a></dt> <dd> <p>A string indicating where the page expects the prerendered content to be activated. The directive not supported for prefetch speculations. Allowed values are:</p> <dl> <dt id="target_hint__blank"><a href="#target_hint__blank"><code>"target_hint": "_blank"</code></a></dt> <dd> <p>Open rerendered content in a new page.</p> </dd> <dt id="target_hint__self"><a href="#target_hint__self"><code>"target_hint": "_self"</code></a></dt> <dd> <p>Open rerendered content in the current page. This is the default, if not specified.</p> </dd> </dl> </dd> </dl> <div class="notecard note"> <p><strong>Note:</strong> As speculation rules use a <code>&lt;script&gt;</code> element, they need to be explicitly allowed in the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Content-Security-Policy"><code>Content-Security-Policy</code></a> <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Content-Security-Policy/script-src"><code>script-src</code></a> directive if the site includes it. This is done by adding the <code>"inline-speculation-rules"</code> value along with a hash- or nonce-source.</p> </div>
</div>
<h2 id="examples">Examples</h2>

<h3 id="prefetch_and_prerender_in_the_same_set_of_rules">Prefetch and prerender in the same set of rules</h3>
<div class="section-content">
<p>The basic examples shown in the description section included separate speculation rules defined for prefetch and prerender. It is possible to define both in a single set of rules:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        "urls": ["next.html", "next2.html"],
        "requires": ["anonymous-client-ip-when-cross-origin"],
        "referrer_policy": "no-referrer"
      }
    ],
    "prerender": [
      {
        "where": { "selector_matches": ".product-link" },
        "eagerness": "eager"
      }
    ]
  }
&lt;/script&gt;
</pre></div> <div class="notecard note"> <p><strong>Note:</strong> This code snippet provides a list (<code>"urls"</code>) rule and a document (<code>"where"</code>) rule example.</p> </div>
</div>
<h3 id="multiple_rule_sets">Multiple rule sets</h3>
<div class="section-content">
<p>It is also allowable to include multiple sets of rules in a single HTML file:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        "urls": ["next.html", "next2.html"],
        "requires": ["anonymous-client-ip-when-cross-origin"],
        "referrer_policy": "no-referrer"
      }
    ]
  }
&lt;/script&gt;
&lt;script type="speculationrules"&gt;
  {
    "prerender": [
      {
        "where": { "selector_matches": ".product-link" },
        "eagerness": "eager"
      }
    ]
  }
&lt;/script&gt;
</pre></div> <p>And multiple rules in a single result set:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prerender": [
      {
        "urls": ["one.html"]
      },
      {
        "urls": ["two.html"]
      }
    ]
  }
&lt;/script&gt;
</pre></div>
</div>
<h3 id="dynamic_rule_insertion">Dynamic rule insertion</h3>
<div class="section-content">
<p>Below is an example that feature detects speculation rules and, if supported, dynamically adds a prerender speculation rule via JavaScript:</p> <div class="code-example"><pre data-language="js">if (
  HTMLScriptElement.supports &amp;&amp;
  HTMLScriptElement.supports("speculationrules")
) {
  const specScript = document.createElement("script");
  specScript.type = "speculationrules";
  const specRules = {
    prerender: [
      {
        urls: ["/next.html"],
      },
    ],
  };
  specScript.textContent = JSON.stringify(specRules);
  console.log("added speculation rules to: next.html");
  document.body.append(specScript);
}
</pre></div> <p>You can see this in action in this <a href="https://prerender-demos.glitch.me/" target="_blank">prerender demos</a> page.</p>
</div>
<h3 id="where_syntax_examples">
<code>where</code> syntax examples</h3>
<div class="section-content">
<p>A document-sourced rule contains a <code>"where"</code> property, which is an object containing criteria that define which links in the document are matched. Effectively, the <code>"where"</code> object represents a test that is performed on every link on the page to see whether the speculation rule is applied to it.</p> <p>The most basic version will match a single URL pattern or CSS selector:</p> <div class="code-example"><pre data-language="json">{ "where": { "href_matches": "/next" } }
</pre></div> <div class="code-example"><pre data-language="json">{ "where": { "selector_matches": ".important-link" } }
</pre></div> <p><code>"href_matches"</code> and <code>"selector_matches"</code> can also be set to an array of values, so multiple URL patterns or CSS selectors can be matched simultaneously:</p> <div class="code-example"><pre data-language="json">{ "where": { "href_matches": ["/next", "/profile"] } }
</pre></div> <div class="code-example"><pre data-language="json">{ "where": { "selector_matches": [".important-link", "#unique-link"] } }
</pre></div> <p>URL patterns and selectors can also contain wildcard (<code>*</code>) characters, allowing a single value to match multiple URLs. For example, the object below could match <code>user/</code>, <code>user/settings</code>, <code>user/stats</code>, etc.</p> <div class="code-example"><pre data-language="json">{ "where": { "href_matches": "/user/*" } }
</pre></div> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/URL/search">Search parameters (or query strings)</a> can also be targeted in <code>href_matches</code>. For example, the object below could match all same-origin URLs with a <code>category</code> search parameter (as the first or a subsequent parameter):</p> <div class="code-example"><pre data-language="json">{ "where": { "href_matches": "/*\\?*(^|&amp;)category=*" } }
</pre></div> <p>Any condition can be negated by placing it inside a <code>"not"</code> condition — this means that, when matched, a link <em>won't</em> have the speculation rule applied to it, but when <em>not</em> matched, it <em>will</em>. The following example will cause all links that <em>don't</em> match the URL pattern <code>/logout</code> to have the rule applied to them, but not links that match <code>/logout</code>:</p> <div class="code-example"><pre data-language="json">{ "where": { "not": { "href_matches": "/logout" } } }
</pre></div> <h4 id="combining_multiple_where_conditions_with_and_or_or">Combining multiple <code>"where"</code> conditions with <code>"and"</code> or <code>"or"</code>
</h4> <p>Multiple conditions can be combined inside <code>"and"</code> or <code>"or"</code> conditions — these take the value of arrays containing multiple conditions, all or any of which (respectively) have to match for the speculation rules to apply to a link. Using <code>"and"</code> or <code>"or"</code>, conditions can be nested multiple levels deep — there is no specified limit on allowed nesting levels.</p> <p>It is useful to think of the <code>"where"</code> object as being equivalent to an <code>if</code> statement. So</p> <pre data-language="plain">{ and: [A, B, { or: [C, { not: D }] }] }
</pre> <p>is equivalent to</p> <pre data-language="plain">if (A &amp;&amp; B &amp;&amp; (C || !D)) {
  apply speculation rule
}
</pre> <p>In the following complete speculation rule example, all same-origin pages are marked for prefetching except those known to be problematic — the <code>/logout</code> page, and any links marked up with a class of <code>.no-prerender</code>:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        "where": {
          "and": [
            { "href_matches": "/*" },
            { "not": { "href_matches": "/logout" } },
            { "not": { "selector_matches": ".no-prerender" } }
          ]
        }
      }
    ]
  }
&lt;/script&gt;
</pre></div> <div class="notecard note"> <p><strong>Note:</strong> The <code>where</code> pattern above does not include cross-site links, which are supported for prefetching (provided the user has no cookies set for the destination site, to protect against tracking) but not for prerendering.</p> </div>
</div>
<h3 id="relative_to_example">
<code>"relative_to"</code> example</h3>
<div class="section-content">
<p>For rule sets that are externally fetched (i.e., via the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Speculation-Rules"><code>Speculation-Rules</code></a>) response header, URLs in list rules and URL patterns in document rules are parsed relative to the containing external text file's URL by default. To parse URLs in a list rule relative to the document's base URL, <code>"relative_to"</code> is used like this:</p> <div class="code-example"><pre data-language="json">{
  "urls": ["/home", "/about"],
  "relative_to": "document"
}
</pre></div> <p>For document rules, <code>"relative_to"</code> can be paired directly with <code>"href_matches"</code> and the document's base URL would only be used for patterns in that particular condition:</p> <div class="code-example"><pre data-language="json">{
  "where": {
    "or": [
      { "href_matches": "/home", "relative_to": "document" },
      { "href_matches": "/about" }
    ]
  }
}
</pre></div> <p>In the above example, only the first <code>"href_matches"</code> will be matched relative to the document's base URL.</p> <p><code>relative_to</code> is mainly relevant if the speculation rules JSON file is on a different origin to the document you wish to apply them to:</p> <ol> <li> <p>If the document is located at <code>https://example.com/some/subpage.html</code> and the rules are at <code>https://example.com/resources/rules.json</code>, then <code>/home</code> always equates to <code>https://example.com/home</code> regardless of whether <code>relative_to</code> is set to <code>document</code> or <code>ruleset</code>.</p> </li> <li> <p>However, if the document is located at <code>https://example.com/some/subpage.html</code> and the rules are at <code>https://other.example/resources/rules.json</code> (for example, on a third-party or cookieless resource origin), then:</p> <ul> <li>
<code>"relative_to": "document"</code> will cause <code>/home</code> to equate to <code>https://example.com/home</code>.</li> <li>
<code>"relative_to": "ruleset"</code> will cause <code>/home</code> to equate to <code>https://other.example/home</code>.</li> </ul> <p>This is the typical use case for <code>"relative_to"</code>.</p> </li> <li> <p>Another potential (but rarer) use case is when your URLs are specified in the form <code>home</code> instead of <code>/home</code>. If the document is located at <code>https://example.com/some/subpage.html</code> and the rules are at <code>https://example.com/resources/rules.json</code>, then:</p> <ul> <li>
<code>"relative_to": "document"</code> would cause <code>home</code> to equate to <code>https://example.com/some/home</code>.</li> <li>
<code>"relative_to": "ruleset"</code> would cause <code>home</code> to equate to <code>https://example.com/resources/home</code>.</li> </ul> </li> </ol>
</div>
<h3 id="expects_no_vary_search_example">
<code>"expects_no_vary_search"</code> example</h3>
<div class="section-content">
<p>Consider the case of a user directory landing page, <code>/users</code>, which has an <code>id</code> parameter added to bring up information on a specific user, for example <code>/users?id=345</code>. Whether this URL should be considered identical for caching purposes depends on the behavior of the application:</p> <ol> <li>If this parameter has the effect of loading a completely new page containing the information for the specified user, then the URL should be cached separately.</li> <li>If this parameter has the effect of highlighting the specified user on the same page, and perhaps revealing a pullout panel displaying their data, then the URL should be considered the same for caching purposes. This could result in performance improvements around the loading of the user pages and could be achieved via a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/No-Vary-Search"><code>No-Vary-Search</code></a> with a value of <code>params=("id")</code>.</li> </ol> <p>How does this affect speculation rules? Consider the following code:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        "urls": ["/users"]
      }
    ]
  }
&lt;/script&gt;
&lt;a href="/users?id=345"&gt;User Bob&lt;/a&gt;
</pre></div> <p>What would happen in this case when the user starts a navigation to <code>/users?id=345</code> when the headers for the prefetch of <code>/users</code> have not been received yet? At this point, the browser doesn't know what the <code>No-Vary-Search</code> value will be, if anything. If there was no <code>No-Vary-Search</code> value set, and the application behavior was more like Option 1 above, the prefetch would be wasted and the browser would need to go and fetch the separate <code>/users?id=345</code> page from scratch.</p> <p>To solve this, we can provide a hint as to what the page author expects the <code>No-Vary-Search</code> value to be. A speculation rule can have an <code>"expects_no_vary_search"</code> field, which contains a string representation of the expected header value:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        "urls": ["/users"],
        "expects_no_vary_search": "params=(\"id\")"
      }
    ]
  }
&lt;/script&gt;
&lt;a href="/users?id=345"&gt;User Bob&lt;/a&gt;
</pre></div> <p>This indicates that Option 2 described above is what the server is expected to produce. If a navigation starts while there is an ongoing prefetch of <code>/users</code>, this informs the browser that it is appropriate to wait for the prefetch, instead of immediately starting another fetch for <code>/users?id=345</code>.</p> <p>Document rules can also be used in conjunction with <code>"expects_no_vary_search"</code>, depending on the pattern used. For example, in the case of:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        { "where": { "href_matches": "/users?id=*" } },
        "expects_no_vary_search": "params=(\"id\")"
      }
    ]
  }
&lt;/script&gt;
&lt;a href="/users?id=012"&gt;User Bill&lt;/a&gt;
&lt;a href="/users?id=345"&gt;User Bob&lt;/a&gt;
&lt;a href="/users?id=678"&gt;User Ben&lt;/a&gt;
</pre></div> <p>If a link is hovered over, the browser will start prefetching that specific link.</p> <p>If the user hovers over another link before the prefetch completes, the <code>expects_no_vary_search</code> pattern tells the browser that there is no need to cancel the current prefetch, because all <code>/users</code> URLs with <code>id</code> URL parameter values effectively point to the same page for this context (and for caching purposes).</p> <div class="notecard warning"> <p><strong>Warning:</strong> Additional care must be taken when using prerender with <code>No-Vary-Search</code> since the page may initially be prerendered with different URL parameters. <code>No-Vary-Search</code> is used for URL parameters that deliver the same resource from the server, but are used by the client for various reasons (client-side rendering, UTM parameters for analytics measurement, etc.). As the initial prerender may be for different URL parameters, any code depending on them should only run after prerender activation.</p> </div> <p>Multiple params can be provided in a space-separated array:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      {
        { "where": { "href_matches": "/users?id=*" } },
        "expects_no_vary_search": "params=(\"id\" \"order\" \"lang\")"
      }
    ]
  }
&lt;/script&gt;
</pre></div> <div class="notecard note"> <p><strong>Note:</strong> As a <a href="https://www.rfc-editor.org/rfc/rfc8941" target="_blank">structured field</a>, the parameters should be space-separated, quoted strings — as shown above — and not comma-separated, which developers may be more used to.</p> </div>
</div>
<h3 id="eagerness_example">
<code>eagerness</code> example</h3>
<div class="section-content">
<p>The following set of document rules shows how <code>eagerness</code> can be used to hint at the eagerness with which the browser should prerender each matching set of links.</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prerender": [
      {
        "where": { "href_matches": "/*" },
        "eagerness": "conservative"
      },
      {
        "where": { "selector_matches": ".product-link" },
        "eagerness": "eager"
      }
    ]
  }
&lt;/script&gt;
</pre></div> <p>Here we are hinting that:</p> <ul> <li>All same-site links contained in the document should be conservatively prerendered (i.e., when the user starts to activate them).</li> <li>Any product links (in this case, those with a <code>class</code> of <code>.product-link</code>) in the document should be eagerly prerendered (i.e., if the user makes any kind of move towards navigating to them).</li> </ul> <div class="notecard note"> <p><strong>Note:</strong> The effects of eagerness settings are less useful for list rules. By default, list rule URLs are prefetched/prerendered immediately as soon as the rules are parsed, which is what you'd expect — they are intended for explicit listing of high-priority URLs that you want to make available as soon as possible. For this reason, <code>eager</code> has the same effect as <code>immediate</code> in current implementations. Lower eagerness settings are for prefetching/prerendering when links are interacted with, and for these you are more likely to use document rules to find them on the page.</p> </div>
</div>
<h3 id="tag_example">
<code>tag</code> example</h3>
<div class="section-content">
<p>A <code>tag</code> can be included at the top level, to identify the overall ruleset:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "tag": "my-rules",
    "prerender": [
      {
        "where": { "href_matches": "/*" },
        "eagerness": "conservative"
      }
    ]
  }
&lt;/script&gt;
</pre></div> <p>Or to identify individual rules:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "prefetch": [
      "tag": "my-prefetch-rule",
      "urls": ["next.html"]
    ],
    "prerender": [
      "tag": "my-prerender-rule",
      "urls": ["next2.html"]
    ],
  }
&lt;/script&gt;
</pre></div> <p>See <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Sec-Speculation-Tags"><code>Sec-Speculation-Tags</code></a> for more examples.</p>
</div>
<h3 id="target_hint_example">
<code>target_hint</code> example</h3>
<div class="section-content">
<p>A <code>target_hint</code> can be included to indicate the target window in which matching prerender speculations will be opened:</p> <div class="code-example"><pre data-language="html">&lt;script type="speculationrules"&gt;
  {
    "tag": "my-rules",
    "prerender": [
      {
        "eagerness": "eager",
        "target_hint": "_blank",
        "urls": ["page2.html"]
      }
    ]
  }
&lt;/script&gt;
</pre></div> <p>The rules above allow the following links to be prerendered correctly in the appropriate targets:</p> <div class="code-example"><pre data-language="html">&lt;a href="page1.html"&gt;Open link in this window&lt;/a&gt;
&lt;a target="_blank" href="page2.html"&gt;Open link in new window&lt;/a&gt;
</pre></div> <p><code>target_hint</code> is only needed for list rules, which use <code>urls</code>. They are not needed for document rules (which use <code>where</code>) since in these the target can be known from the <code>target</code> attribute of the <code>&lt;a&gt;</code> link element.</p>
</div>
<h2 id="specifications">Specifications</h2>
<div class="_table"><table class="standard-table">
<thead><tr><th scope="col">Specification</th></tr></thead>
<tbody><tr><td><a href="https://wicg.github.io/nav-speculation/speculation-rules.html#speculation-rules-script">Speculation Rules <br><small># speculation-rules-script</small></a></td></tr></tbody>
</table></div>
<h2 id="browser_compatibility">Browser compatibility</h2>
<div class="_table"><table>
<thead>
<tr id="bct-browser-type">
<th></th>
<th colspan="5">Desktop</th>
<th colspan="6">Mobile</th>
</tr>
<tr id="bct-browsers">
<th></th>
<th>Chrome</th>
<th>Edge</th>
<th>Firefox</th>
<th>Opera</th>
<th>Safari</th>
<th>Chrome Android</th>
<th>Firefox for Android</th>
<th>Opera Android</th>
<th>Safari on IOS</th>
<th>Samsung Internet</th>
<th>WebView Android</th>
</tr>
</thead>
<tbody>
<tr>
<th><code>speculationrules</code></th>
<td class="bc-supports-yes">109<details><summary>105–109</summary>Initial support included same-origin prerendering only.</details>
</td>
<td class="bc-supports-yes">109<details><summary>105–109</summary>Initial support included same-origin prerendering only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">95<details><summary>91–95</summary>Initial support included same-origin prerendering only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">109<details><summary>103–109</summary>Initial support included same-origin prerendering only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">74<details><summary>71–74</summary>Initial support included same-origin prerendering only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">21.0<details><summary>20.0–21.0</summary>Initial support included same-origin prerendering only.</details>
</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>eagerness</code></th>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">107</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">81</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">25.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>expects_no_vary_search</code></th>
<td class="bc-supports-yes">127<details><summary>121–127</summary>Supported for <code>prefetch</code> only.</details>
</td>
<td class="bc-supports-yes">127<details><summary>121–127</summary>Supported for <code>prefetch</code> only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">113<details><summary>107–113</summary>Supported for <code>prefetch</code> only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">127<details><summary>121–127</summary>Supported for <code>prefetch</code> only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">84<details><summary>81–84</summary>Supported for <code>prefetch</code> only.</details>
</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes"><details><summary>25.0</summary>Supported for <code>prefetch</code> only.</details></td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>prefetch</code></th>
<td class="bc-supports-yes">110</td>
<td class="bc-supports-yes">110</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">96</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">103</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">71</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">20.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>prerender</code></th>
<td class="bc-supports-yes">105</td>
<td class="bc-supports-yes">105</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">91</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">103</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">71</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">20.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>referrer_policy</code></th>
<td class="bc-supports-yes">111</td>
<td class="bc-supports-yes">111</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">97</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">111</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">75</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">22.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>relative_to</code></th>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">107</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">81</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">25.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>requires</code></th>
<td class="bc-supports-yes">110</td>
<td class="bc-supports-yes">110</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">96</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">103</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">71</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">20.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>source_optional</code></th>
<td class="bc-supports-yes">122</td>
<td class="bc-supports-yes">122</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">108</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">122</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">81</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">26.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>tag</code></th>
<td class="bc-supports-yes">136</td>
<td class="bc-supports-yes">136</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">136</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>target_hint</code></th>
<td class="bc-supports-yes"><details><summary>138</summary>Only <code>"_blank"</code> and <code>"_self"</code> are supported and only for prefetch.</details></td>
<td class="bc-supports-yes"><details><summary>138</summary>Only <code>"_blank"</code> and <code>"_self"</code> are supported and only for prefetch.</details></td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes"><details><summary>138</summary>Only <code>"_blank"</code> and <code>"_self"</code> are supported and only for prefetch.</details></td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>urls</code></th>
<td class="bc-supports-yes">109</td>
<td class="bc-supports-yes">109</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">95</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">103</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">71</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">20.0</td>
<td class="bc-supports-no">No</td>
</tr>
<tr>
<th><code>where</code></th>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">107</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">121</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">81</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes">25.0</td>
<td class="bc-supports-no">No</td>
</tr>
</tbody>
</table></div>
<h2 id="see_also">See also</h2>
<div class="section-content"><ul> <li>
<a href="https://developer.chrome.com/docs/web-platform/prerender-pages" target="_blank">Prerender pages in Chrome for instant page navigations</a> on developer.chrome.com</li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/Performance/Guides/Speculative_loading">Speculative loading</a></li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Speculation_Rules_API">Speculation Rules API</a></li> </ul></div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2005&ndash;2025 MDN contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v2.5 or later.<br>
    <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/script/type/speculationrules" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/script/type/speculationrules</a>
  </p>
</div>
</div>
            </main>
        </div>
    </div>
    <script type="text/javascript" src="../../../../assets/index.js"></script>
</body>

</html>